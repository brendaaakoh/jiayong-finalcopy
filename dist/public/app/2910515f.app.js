"use strict";angular.module("jiayongApp",["ngCookies","ngResource","ngSanitize","btford.socket-io","ui.router","ui.bootstrap","ionic"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider","$ionicConfigProvider",function(a,b,c,d,e){e.views.maxCache(1),a.state("app",{"abstract":!0,templateUrl:"app/app.html",controller:"AppCtrl",resolve:{resolvedUser:["User",function(a){return a.get()}]}}),b.otherwise("/"),c.html5Mode(!0),d.interceptors.push("authInterceptor")}]).factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers.Authorization="Bearer "+c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/landing"),c.remove("token"),b.reject(a)):b.reject(a)}}}]).run(["$rootScope","$location","Auth","$ionicHistory","$state","$stateParams","$ionicViewSwitcher",function(a,b,c,d,e,f,g){a.goback=function(){d.goBack()},a["goto"]=function(a){d.nextViewOptions({historyRoot:!0,disableAnimate:!0,disableBack:!0}),d.clearCache(),e.go(a)},a.clearHistoryAndGo=function(a){d.nextViewOptions({historyRoot:!0,disableAnimate:!0,disableBack:!0}),d.clearCache(),e.go(a)},a.$on("$stateChangeStart",function(a,d){c.isLoggedInAsync(function(a){d.authenticate&&!a&&b.path("/login")})})}]),angular.module("jiayongApp").controller("AppCtrl",["$scope","$rootScope","User","socket","resolvedUser",function(a,b,c,d,e){a.user=e,console.log(a.user)}]),angular.module("jiayongApp").factory("Tasks",function(){var a=[{id:1,title:"Wash the Balcony",status:"Completed",desc:"Wash the balcony floor",exp:"A clean floor with no watermarks!",min:8,max:15,earnings:15,prereq:"",remarks:""},{id:2,title:"Do laundry!",status:"In Progress",desc:"Wash the clothes in the laundry basket, then take it out to hang",exp:"Clothes to be hung on the rack!",min:10,max:15,earnings:0,prereq:"",remarks:""},{id:3,title:"Walk Lucy",status:"Available",desc:"Lucy needs some exercise!",exp:"Walk from our block to the playground at least!",min:20,max:25,earnings:0,prereq:"",remarks:""},{id:4,title:"Bathe Lucy",status:"Available",desc:"Shampoo and blow dry the dog. She stinks!",exp:"A neater and cleaner Lucy please!",min:20,max:28,earnings:0,prereq:"Walk Lucy",remarks:""},{id:5,title:"Clean out the Fridge!",status:"Available",desc:"Something smells bad in the fridge! Can someone help clean it out?",exp:"Remove the source of the smell and stack up everything else nicely and neatly.",min:20,max:30,earnings:0,prereq:"",remarks:""},{id:6,title:"Change the Bedsheets",status:"Pending Completion",desc:"No one has changed the bedsheets since we came back from Japan!",exp:"Just change it to a fresh set, any design will do.",min:15,max:20,earnings:0,prereq:"",remarks:""},{id:7,title:"Buying Vegetables!",status:"Available",desc:"Need some vege to cook this weekend! Carrots and peas sound good!",exp:"2 packets of each inside the fridge vegetable compartment",min:15,max:20,earnings:0,prereq:"Clean out the Fridge!",remarks:""},{id:8,title:"Packing the bookshelf",status:"Available",desc:"The bookshelf in the study seems to be overloaded, some clearing is needed",exp:"Clear away some old books so everything can be arranged on it nicely.",min:18,max:25,earnings:0,prereq:"",remarks:""},{id:9,title:"Mop your own bedroom floor!",status:"Available",desc:"Your bedroom has not been mopped in a week!",exp:"A clean floor with no watermarks!",min:20,max:30,earnings:0,prereq:"",remarks:""},{id:10,title:"Ironing of clothes",status:"Pending Approval",desc:"There is a pile of clothing in the room which needs ironing",exp:"Ironed and folded clothes nicely stacked up on the bed",min:30,max:50,earnings:0,prereq:"",remarks:""},{id:11,title:"Sweeping of Floor",status:"Rejected Proposal",desc:"The floor is kind of dusty, can I sweep it?",exp:"A dust free bedroom floor!",min:10,max:15,earnings:0,prereq:"",remarks:"This is not needed"}];return{getAll:function(){return a},getPending:function(){var b,c=[];for(b=0;b<a.length;b++)("Pending Completion"==a[b].status||"Pending Approval"==a[b].status)&&c.push(a[b]);return c},getProgress:function(){var b,c=[];for(b=0;b<a.length;b++)"In Progress"==a[b].status&&c.push(a[b]);return c},getCompleted:function(){var b,c=[];for(b=0;b<a.length;b++)"Completed"==a[b].status&&c.push(a[b]);return c},getAvailable:function(){var b,c=[];for(b=0;b<a.length;b++)"Available"==a[b].status&&c.push(a[b]);return c},getRejected:function(){var b,c=[];for(b=0;b<a.length;b++)("Rejected Proposal"==a[b].status||"Rejected Completion"==a[b].status)&&c.push(a[b]);return c},getTask:function(b){for(var c=a.length-1;c>=0;c--)if(a[c].id==b)return a[c]},takeupTask:function(b){for(var c=a.length-1;c>=0;c--)a[c].id==b&&(a[c].status="In Progress")},removeTask:function(b){for(var c=a.length-1;c>=0;c--)a[c].id==b&&(a[c].status="Available")},createTask:function(b,c,d,e,f){a.push({id:a.length+1,title:b,status:"Pending Approval",desc:c,exp:d,min:e,max:f,earnings:0})},editTask:function(b,c,d,e,f,g){for(var h=a.length-1;h>=0;h--)a[h].id==b&&(a[h].title=c,a[h].desc=d,a[h].exp=e,a[h].min=f,a[h].max=g,a[h].status="Pending Approval")},addTask:function(b,c,d,e,f,g){a.push({id:a.length+1,title:b,status:"Available",desc:c,exp:d,min:e,max:f,earnings:0,prereq:g})},completeTask:function(b){for(var c=a.length-1;c>=0;c--)a[c].id==b&&(a[c].status="Pending Completion")},approveTask:function(b,c){for(var d=a.length-1;d>=0;d--)a[d].id==b&&(a[d].status="Completed",a[d].earnings=c)},getByTitle:function(b){for(var c=a.length-1;c>=0;c--)if(a[c].title==b)return a[c]}}}).run(["$rootScope","Tasks",function(a,b){a.Tasks=b}]),angular.module("jiayongApp").config(["$stateProvider",function(a){a.state("login",{url:"/login",templateUrl:"app/account/login/login.html",controller:"LoginCtrl"}).state("signup",{url:"/signup",templateUrl:"app/account/signup/signup.html",controller:"SignupCtrl"})}]),angular.module("jiayongApp").controller("LoginCtrl",["$scope","Auth","$location","$state","$ionicHistory","User","$ionicLoading",function(a,b,c,d,e,f,g){a.user={},a.errors={},a.login=function(c){a.submitted=!0,c.$valid&&b.login({email:a.user.email,password:a.user.password}).then(function(){g.show({content:"Loading",animation:"fade-in",template:"Logging You In..."}),f.get(function(a){0==a.children.length?(console.log("Child"),d.go("app.main",{},{reload:!0}),g.hide(),e.nextViewOptions({historyRoot:!0,disableAnimate:!0,disableBack:!0})):(console.log("Parent"),d.go("app.parent",{},{reload:!0}),g.hide(),e.nextViewOptions({historyRoot:!0,disableAnimate:!0,disableBack:!0}))},function(a){d.go("landing",{},{reload:!1})})})["catch"](function(b){a.errors.other=b.message})}}]),angular.module("jiayongApp").config(["$stateProvider",function(a){a.state("landing",{url:"/landing",templateUrl:"app/account/login/login.html",controller:"LoginCtrl"})}]),angular.module("jiayongApp").controller("SignupCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")})["catch"](function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.message})})}}]),angular.module("jiayongApp").controller("AdminCtrl",["$scope","$http","Auth","User",function(a,b,c,d){a.users=d.query(),a["delete"]=function(b){d.remove({id:b._id}),angular.forEach(a.users,function(c,d){c===b&&a.users.splice(d,1)})}}]),angular.module("jiayongApp").config(["$stateProvider",function(a){a.state("admin",{url:"/admin",templateUrl:"app/admin/admin.html",controller:"AdminCtrl"})}]),angular.module("jiayongApp").controller("CreateCtrl",["$scope","Tasks","$ionicPopup","User",function(a,b,c,d){d.get(function(b){a.user=b,console.log(b)}),a.tasksAvailable=b.getAvailable(),a.create=function(a,d,e,f,g){b.createTask(a,d,e,f,g),c.alert({title:"Success!",template:"You successfully created your task!"})}}]),angular.module("jiayongApp").config(["$stateProvider",function(a){a.state("app.create",{url:"/create",views:{menuContent:{templateUrl:"app/create/create.html",controller:"CreateCtrl"}}})}]),angular.module("jiayongApp").controller("MainCtrl",["$scope","$http","socket","Tasks","$ionicPopup","User",function(a,b,c,d,e,f){f.get(function(b){a.user=b,console.log(b)}),a.tasks=d.getAll(),a.tasksPending=d.getPending(),a.tasksProgress=d.getProgress(),a.tasksAvailable=d.getAvailable(),a.tasksRejected=d.getRejected(),a.remove=function(a){var b=e.confirm({title:"Remove Task",template:"Are you sure you want to remove this incomplete task?"});b.then(function(b){b&&d.removeTask(a)})}}]),angular.module("jiayongApp").controller("MainEditCtrl",["$scope","$http","socket","task","Tasks","$ionicPopup",function(a,b,c,d,e,f){a.task=d,console.log(a.task),a.sendApproval=function(a){e.completeTask(a),f.alert({title:"Success!",template:"Your task has been sent for approval!"})}}]),angular.module("jiayongApp").config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("app.main",{url:"/childhome",views:{menuContent:{templateUrl:"app/main/main.html",controller:"MainCtrl",resolve:{tasks:["$stateParams","Tasks",function(a,b){return b.getAll()}]}}}}).state("app.pending",{url:"/pending",views:{menuContent:{templateUrl:"app/main/main.pending.html",controller:"MainCtrl"}}}).state("app.progress",{url:"/progress",views:{menuContent:{templateUrl:"app/main/main.progress.html",controller:"MainCtrl"}}}).state("app.completed",{url:"/completed",views:{menuContent:{templateUrl:"app/main/main.completed.html",controller:"MainCtrl"}}}).state("app.rejected",{url:"/rejected",views:{menuContent:{templateUrl:"app/main/main.rejected.html",controller:"MainCtrl"}}}).state("app.find",{url:"/findTasks",views:{menuContent:{templateUrl:"app/main/main.list.html",controller:"MainCtrl"}}}).state("app.details",{url:"/:id",views:{menuContent:{templateUrl:"app/main/main.single.html",controller:"MainSingleCtrl",resolve:{task:["$stateParams","Tasks",function(a,b){return b.getTask(a.id)}]}}}}).state("edit",{url:"/edit/:id",views:{menuContent:{templateUrl:"app/main/main.edit.html",controller:"MainEditCtrl",resolve:{task:["$stateParams","Tasks",function(a,b){return b.getTask(a.id)}]}}}})}]),angular.module("jiayongApp").controller("MainSingleCtrl",["$scope","$http","socket","task","Tasks","$ionicPopup",function(a,b,c,d,e,f){a.task=d,console.log(a.task),a.takeup=function(a){var b=e.getTask(a);if(""!=b.prereq){var c=e.getByTitle(b.prereq);"Completed"!=c.status?f.alert({title:"Error!",template:"<center> The task <b>"+b.prereq+"</b> has to be done first! </center>"}):(e.takeupTask(a),f.alert({title:"Success!",template:"You have taken up the task!"}))}else e.takeupTask(a),f.alert({title:"Success!",template:"You have taken up the task!"})},a.remove=function(a){var b=f.confirm({title:"Remove Task",template:"Are you sure you want to remove this incomplete task?"});b.then(function(b){b&&e.removeTask(a)})},a.sendApproval=function(a){e.completeTask(a),f.alert({title:"Success!",template:"Your task has been sent for approval!"})}}]),angular.module("jiayongApp").controller("ParentCtrl",["$scope","Tasks","$state","$ionicPopup",function(a,b,c,d){a.viewTask=function(b){d.show({title:"You have a new Task Pending approval!",scope:a,buttons:[{text:"View Later!"},{text:"<b>View Now!</b>",type:"button-positive",onTap:function(a){c.go("app.details/"+b)}}]})}}]),angular.module("jiayongApp").config(["$stateProvider",function(a){a.state("app.parent",{url:"/home",views:{menuContent:{templateUrl:"app/parent/parent.html",controller:"ParentCtrl",resolve:{tasks:["$stateParams","Tasks",function(a,b){return b.getAll()}]}}}})}]),angular.module("jiayongApp").controller("MainSingleCtrl",["$scope","$http","socket","task","Tasks","$ionicPopup",function(a,b,c,d,e,f){a.task=d,console.log(a.task),a.takeup=function(a){var b=e.getTask(a);if(""!=b.prereq){var c=e.getByTitle(b.prereq);"Completed"!=c.status?f.alert({title:"Error!",template:"<center> The task <b>"+b.prereq+"</b> has to be done first! </center>"}):(e.takeupTask(a),f.alert({title:"Success!",template:"You have taken up the task!"}))}else e.takeupTask(a),f.alert({title:"Success!",template:"You have taken up the task!"})},a.remove=function(a){var b=f.confirm({title:"Remove Task",template:"Are you sure you want to remove this incomplete task?"});b.then(function(b){b&&e.removeTask(a)})},a.sendApproval=function(a){e.completeTask(a),f.alert({title:"Success!",template:"Your task has been sent for approval!"})}}]),angular.module("jiayongApp").controller("ProfileCtrl",["$ionicHistory","$scope","$http","$rootScope","$ionicTabsDelegate","$state","$location","$window","User","Auth",function(a,b,c,d,e,f,g,h,i,j){i.get(function(a){b.user=a,console.log(a)}),b.logout=function(){j.logout(),a.clearCache(),f.go("landing")}}]),angular.module("jiayongApp").config(["$stateProvider",function(a){a.state("app.profile",{url:"/profile",views:{menuContent:{templateUrl:"app/profile/profile.html",controller:"ProfileCtrl"}}})}]),angular.module("jiayongApp").factory("Auth",["$location","$rootScope","$http","User","$cookieStore","$q","$ionicPopup","$ionicLoading",function(a,b,c,d,e,f,g,h){var i={};return e.get("token")&&(i=d.get()),{login:function(a,b){var h=b||angular.noop,j=f.defer();return c.post("/auth/local",{email:a.email,password:a.password}).success(function(a){return e.put("token",a.token),i=d.get(),j.resolve(a),h()}).error(function(a){return g.alert({title:"Login Failed",template:"Invalid Username/Password!"}),this.logout(),j.reject(a),h(a)}.bind(this)),j.promise},logout:function(){e.remove("token"),i={}},createUser:function(a,b){var c=b||angular.noop;return d.save(a,function(b){return e.put("token",b.token),i=d.get(),c(a)},function(a){return this.logout(),c(a)}.bind(this)).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.changePassword({id:i._id},{oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},getCurrentUser:function(){return i},isLoggedIn:function(){return i.hasOwnProperty("role")},isLoggedInAsync:function(a){i.hasOwnProperty("$promise")?i.$promise.then(function(){a(!0)})["catch"](function(){a(!1)}):a(i.hasOwnProperty("role")?!0:!1)},isAdmin:function(){return"admin"===i.role},getToken:function(){return e.get("token")}}}]),angular.module("jiayongApp").factory("User",["$resource",function(a){return a("/api/users/:id/:controller",{id:"@_id"},{changePassword:{method:"PUT",params:{controller:"password"}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("jiayongApp").factory("Modal",["$rootScope","$modal",function(a,b){function c(c,d){var e=a.$new();return c=c||{},d=d||"modal-default",angular.extend(e,c),b.open({templateUrl:"components/modal/modal.html",windowClass:d,scope:e})}return{confirm:{"delete":function(a){return a=a||angular.noop,function(){var b,d=Array.prototype.slice.call(arguments),e=d.shift();b=c({modal:{dismissable:!0,title:"Confirm Delete",html:"<p>Are you sure you want to delete <strong>"+e+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(a){b.close(a)}},{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}}]}},"modal-danger"),b.result.then(function(b){a.apply(b,d)})}}}}}]),angular.module("jiayongApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("jiayongApp").controller("NavbarCtrl",["$scope","$location","Auth",function(a,b,c){a.menu=[{title:"Home",link:"/"}],a.isCollapsed=!0,a.isLoggedIn=c.isLoggedIn,a.isAdmin=c.isAdmin,a.getCurrentUser=c.getCurrentUser,a.logout=function(){c.logout(),b.path("/login")},a.isActive=function(a){return a===b.path()}}]),angular.module("jiayongApp").factory("socket",["socketFactory",function(a){var b=io("",{path:"/socket.io-client"}),c=a({ioSocket:b});return{socket:c,syncUpdates:function(a,b,d){d=d||angular.noop,c.on(a+":save",function(a){var c=_.find(b,{_id:a._id}),e=b.indexOf(c),f="created";c?(b.splice(e,1,a),f="updated"):b.push(a),d(f,a,b)}),c.on(a+":remove",function(a){var c="deleted";_.remove(b,{_id:a._id}),d(c,a,b)})},unsyncUpdates:function(a){c.removeAllListeners(a+":save"),c.removeAllListeners(a+":remove")}}}]);